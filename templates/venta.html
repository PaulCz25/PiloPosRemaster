<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PilotoPOS – Ventas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    :root{
      --brand-900:#0e7490; --brand-700:#0ea5b0; --brand-600:#0891b2; --brand-500:#06b6d4;
      --ink-900:#0f172a; --ink-700:#334155; --ok-600:#059669; --err-600:#dc2626; --soft:#eef7fb;
    }
    html, body { height: 100%; }
    body { font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial,'Apple Color Emoji','Segoe UI Emoji'; }
    .card { border-radius: 1.25rem; background: #fff; box-shadow: 0 10px 15px -3px rgba(0,0,0,.08), 0 4px 6px -4px rgba(0,0,0,.06); border: 1px solid rgba(14,116,144,.08); }
    .soft-divider { border-top: 1px solid rgba(2,6,23,.06); }
    .input { border: 1px solid rgb(165 243 252 / .7); border-radius: 0.75rem; padding: 0.8rem 0.9rem; width: 100%; box-shadow: 0 1px 1px rgba(0,0,0,.03); outline: none; background:#fff; }
    .input:focus { box-shadow: 0 0 0 4px rgba(14,116,144,.14); border-color: var(--brand-600); }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.5rem; border-radius:.85rem; font-weight:700; transition:.15s ease; padding:.8rem 1.1rem; box-shadow: 0 8px 20px -10px rgba(14,116,144,.45); }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--brand-600); color:#fff; }
    .btn-primary:hover { filter:brightness(1.05); }
    .btn-success { background: var(--ok-600); color:#fff; }
    .btn-danger  { background: var(--err-600); color:#fff; }
    .btn-ghost   { background:#fff; color:var(--brand-600); border:1px solid rgba(14,116,144,.25); }
    .pill { padding:.5rem 1rem; border-radius:9999px; font-weight:700; font-size:.9rem; }
    .pill-yes { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .active   { box-shadow: inset 0 0 0 2px rgba(0,0,0,.15); transform: translateY(-1px); }
    .totals-card { background: linear-gradient(180deg,#f7fbff 0%, #f1f6ff 100%); border:1px solid rgba(14,116,144,.15); border-radius:1rem; }
    .is-display button, .is-display .btn, .is-display input, .is-display select,
    .is-display textarea, .is-display form, .is-display a[href] { pointer-events:none !important; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.60)); backdrop-filter:saturate(160%) blur(8px); border:1px solid rgba(14,116,144,.12); border-radius:1rem; }
    .empty-ring { box-shadow: inset 0 0 0 2px rgba(14,116,144,.15); }
    @keyframes pop { from{ transform:scale(.98); opacity:.3 } to{ transform:scale(1); opacity:1 } }
    .pop { animation: pop .18s ease-out; }
  </style>
</head>
<body class="bg-gradient-to-b from-cyan-50 to-white min-h-screen flex">
  <!-- Sidebar -->
  <aside class="hidden md:flex w-72 bg-gradient-to-b from-[var(--brand-900)] to-[var(--brand-600)] text-white flex-col py-8 px-6 shadow-2xl rounded-r-3xl">
    <div class="flex flex-col items-center mb-10">
      <img src="/static/logo-piloto.png" alt="PilotoPOS" class="h-28 w-auto mb-3 drop-shadow-lg" />
      <span class="text-xl font-extrabold tracking-wide text-white/95">PilotoPOS</span>
      <span class="text-xs text-white/70 mt-1">Punto de Venta Abarrotero</span>
    </div>

    <div class="mb-3 text-[.75rem] uppercase tracking-wider text-cyan-100/90">Navegación</div>
    <nav class="flex flex-col gap-2 text-base">
      <a href="/" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="shopping-cart" class="w-5 h-5"></i> Ventas
      </a>
      <a href="/almacen" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="box" class="w-5 h-5"></i> Almacén
      </a>
      <a href="/historial" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="bar-chart" class="w-5 h-5"></i> Historial
      </a>
      <a href="/centavos" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="coins" class="w-5 h-5"></i> Centavos
      </a>
      <a href="/proveedores" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="truck" class="w-5 h-5"></i> Proveedores
      </a>
      <a href="/panel" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="database" class="w-5 h-5"></i> Panel de datos
      </a>
    </nav>

    <div class="mt-8 mb-2 text-[.75rem] uppercase tracking-wider text-cyan-100/90">Cuenta</div>
    <nav class="flex flex-col gap-2 text-base">
      <a href="/usuarios" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="users" class="w-5 h-5"></i> Usuarios
      </a>
      <a href="/login" class="flex items-center gap-3 px-4 py-2 rounded-xl transition hover:bg-white/10">
        <i data-lucide="lock" class="w-5 h-5"></i> Login
      </a>
    </nav>

    <div class="mt-auto pt-6 text-xs text-white/70">
      <div class="flex items-center gap-2"><i data-lucide="radio" class="w-4 h-4"></i><span id="statusText">Conectando…</span></div>
      <div class="mt-2 opacity-80" id="clock"></div>
    </div>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-4 md:p-8">
    <!-- Top bar glass -->
    <div class="glass px-4 py-3 md:px-6 md:py-4 mb-5 flex items-center justify-between rounded-2xl">
      <div class="flex items-center gap-3">
        <div class="hidden md:flex items-center justify-center w-10 h-10 rounded-xl bg-white/70 text-[var(--brand-600)]">
          <i data-lucide="shopping-cart" class="w-5 h-5"></i>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-[var(--brand-900)] leading-tight">Punto de Venta</h1>
          <p class="text-sm text-slate-500">Escanea, cobra y imprime en segundos.</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        {% set ultimo = session.get('ultimo_ticket') %}
        {% if ultimo %}
          <a href="{{ url_for('ticket', vid=ultimo) }}?print=1" title="Imprimir último ticket" class="btn btn-primary hidden md:inline-flex">
            <i data-lucide="printer" class="w-5 h-5"></i><span class="hidden lg:inline">Imprimir último</span>
          </a>
        {% else %}
          <a href="#" title="Aún no hay ticket" class="btn btn-primary hidden md:inline-flex opacity-50 pointer-events-none" aria-disabled="true">
            <i data-lucide="printer" class="w-5 h-5"></i><span class="hidden lg:inline">Imprimir último</span>
          </a>
        {% endif %}
      </div>
    </div>

    <div class="card p-5 md:p-8 max-w-5xl mx-auto pop">
      <!-- Captura -->
      <form method="POST" action="/agregar-producto" class="mb-6" aria-label="Agregar por código">
        <label for="codigo" class="block text-slate-800 font-semibold mb-2">Escanea o ingresa el código:</label>
        <div class="flex gap-2 md:gap-3">
          <input type="text" id="codigo" name="codigo" required autofocus class="input flex-1 text-lg md:text-base" placeholder="Ej: QR123, AZT55, 1234" aria-label="Código de producto" inputmode="text" />
          <button type="submit" class="btn btn-primary px-4 md:px-6" aria-label="Agregar al carrito">
            <i data-lucide="scan" class="w-5 h-5"></i><span class="hidden md:inline">Agregar</span>
          </button>
          <button type="button" class="btn btn-ghost px-4 md:px-6" onclick="abrirManual()" title="Agregar producto manual" aria-haspopup="dialog">
            <i data-lucide="plus" class="w-5 h-5"></i><span class="hidden md:inline">Agregar manual</span>
          </button>
        </div>
      </form>

      {% if mensaje %}
      <div class="bg-yellow-50 text-yellow-800 border border-yellow-100 px-4 py-3 rounded-xl shadow-sm mb-6">
        {{ mensaje }}
      </div>
      {% endif %}

      {% if session.get('ultimo_ticket') %}
      <div class="mb-6 md:hidden">
        <a href="{{ url_for('ticket', vid=session.get('ultimo_ticket')) }}?print=1" class="btn btn-primary w-full" title="Imprimir último ticket">
          <i data-lucide="printer" class="w-5 h-5"></i> Imprimir último ticket
        </a>
        <div class="mt-2 text-center text-sm text-gray-500">Folio: {{ session.get('ultimo_ticket') }}</div>
      </div>
      {% endif %}

      {% if carrito or display_mode %}
      <!-- Carrito -->
      <section class="rounded-2xl border border-gray-200/70 p-5 mb-6" aria-label="Carrito">
        <div class="flex items-center gap-2 text-xl font-extrabold text-slate-800 mb-4">
          <i data-lucide="list-checks" class="w-5 h-5 text-[var(--brand-600)]"></i> Carrito
        </div>

        <ul id="listaCarrito" class="divide-y divide-gray-100 mb-4 min-h-[3.25rem]">
          {% if carrito|length == 0 %}
          <li class="py-8 text-center text-slate-500 empty-ring rounded-xl">Tu carrito está vacío. Escanea un código o agrega manualmente.</li>
          {% else %}
          {% for item in carrito %}
          <li class="py-3 flex items-center justify-between" data-index="{{ loop.index0 }}">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-cyan-50 text-[var(--brand-600)] flex items-center justify-center"><i data-lucide="package" class="w-4 h-4"></i></div>
              <span data-rol="nombre" class="text-slate-900 font-medium">{{ item.nombre }}</span>
            </div>
            <div class="flex items-center gap-4">
              <div data-rol="precio" class="text-slate-900 font-semibold text-lg">${{ '%.2f'|format(item.precio) }}</div>
              <button type="button" onclick="quitarItem('{{ loop.index0 }}')" class="p-2 rounded-lg hover:bg-red-50" title="Quitar del carrito">
                <i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i>
              </button>
            </div>
          </li>
          {% endfor %}
          {% endif %}
        </ul>

        <div class="soft-divider my-4"></div>

        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold text-slate-900">Total</div>
          <div class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight">$ <span id="totalBruto">{{ '%.2f'|format(total) }}</span></div>
        </div>

        <div class="text-right mt-4">
          <!-- Pagar va directo a bloque de pago (sin redondeo) -->
          <button type="button" onclick="mostrarPagoDirecto()" class="btn btn-primary px-5">Pagar</button>
        </div>
      </section>

      <!-- Pago -->
      <section id="bloquePago" class="grid md:grid-cols-[1fr_auto] items-start gap-4 hidden" aria-label="Pago">
        <div class="order-2 md:order-2 md:justify-self-end w-full">
          <div class="flex items-center gap-2 w-full justify-end">
            <label for="pagoCliente" class="font-semibold text-slate-800 whitespace-nowrap">¿Con cuánto pagó el cliente?</label>
            <input type="number" id="pagoCliente" step="0.01" placeholder="$ 0.00" class="input w-40 text-right" inputmode="decimal" />
          </div>

          <div id="cashPresets" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 md:gap-3 mt-3 md:mt-2">
            <button type="button" class="pill pill-yes" data-cash="exact">Exacto</button>
            <button type="button" class="pill pill-yes" data-cash="50">$50</button>
            <button type="button" class="pill pill-yes" data-cash="100">$100</button>
            <button type="button" class="pill pill-yes" data-cash="200">$200</button>
            <button type="button" class="pill pill-yes" data-cash="500">$500</button>
          </div>
        </div>

        <div class="order-1 md:order-1 totals-card p-5 w-full">
          <div id="resultadoCambio" class="hidden space-y-2" aria-live="polite">
            <div class="flex justify-between text-slate-700"><span>Total a pagar:</span><span id="montoTotal" class="font-bold text-slate-900">$0.00</span></div>
            <div class="flex justify-between text-slate-700"><span>Pago recibido:</span><span id="montoPago" class="font-bold text-emerald-600">$0.00</span></div>
            <div class="flex justify-between text-slate-700"><span>Cambio a devolver:</span><span id="montoCambio" class="font-bold text-emerald-600">$0.00</span></div>
          </div>

          <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <button type="button" onclick="calcularCambio()" class="btn btn-success px-4">Calcular cambio</button>
            <div id="finalizarCompra" class="hidden">
              <!-- Se conserva el form/endpoint por compatibilidad; ya no se envía redondeo -->
              <form method="POST" action="/redondear" class="inline-block">
                <input type="hidden" id="campoRedondeo" name="aceptado" value="" />
                <button type="submit" class="btn btn-primary px-6">Finalizar compra</button>
              </form>
            </div>
          </div>
        </div>
      </section>
      {% endif %}
    </div>

    <div id="toast" class="fixed bottom-4 right-4 hidden"></div>

    <!-- Modal: Agregar manual -->
    <div id="modalManual" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="tituloManual">
      <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
        <h3 id="tituloManual" class="text-xl font-extrabold text-[var(--brand-700)] mb-4 flex items-center gap-2">
          <i data-lucide="plus" class="w-5 h-5"></i> Agregar producto manual
        </h3>
        <div class="space-y-3">
          <div>
            <label for="manNombre" class="text-sm font-medium text-slate-700">Nombre</label>
            <input id="manNombre" type="text" class="input mt-1" placeholder="Ej: Queso 1kg" />
          </div>
          <div>
            <label for="manPrecio" class="text-sm font-medium text-slate-700">Precio</label>
            <input id="manPrecio" type="number" step="0.01" min="0" class="input mt-1" placeholder="100.00" inputmode="decimal" />
          </div>
        </div>
        <div class="mt-5 flex gap-2 justify-end">
          <button type="button" class="btn btn-ghost" onclick="cerrarManual()">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="agregarManual()">Añadir</button>
        </div>
      </div>
    </div>
  </main>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    // Utilidades
    function fmt(n){ return Number(n).toFixed(2); }
    function parseMoney(str){ return Number(String(str || '0').replace(/[^\d.]/g, '')) || 0; }

    // Modo DISPLAY por query param
    const params = new URLSearchParams(location.search);
    const DISPLAY = params.get('display') === '1';
    if (DISPLAY) document.body.classList.add('is-display');

    // Socket y estado de conexión
    const socket = io();
    socket.emit('join', { role: DISPLAY ? 'display' : 'admin' });

    const statusText = document.getElementById('statusText');
    socket.on('connect', () => statusText && (statusText.textContent = 'Conectado'));
    socket.on('disconnect', () => statusText && (statusText.textContent = 'Desconectado'));
    socket.on('state', (s) => { renderFromState(s); });

    // ---- Estado DOM -> JSON (sin redondeo) ----
    function collectState(){
      const items = [];
      document.querySelectorAll('#listaCarrito li').forEach(li => {
        const name = li.querySelector('[data-rol="nombre"]')?.textContent?.trim() || '';
        const priceTxt = li.querySelector('[data-rol="precio"]')?.textContent || '0';
        const price = parseMoney(priceTxt);
        if (name) items.push({ nombre: name, precio: price });
      });
      const totalBrutoEl = document.getElementById('totalBruto');
      const total = parseMoney(totalBrutoEl ? totalBrutoEl.textContent : '0');

      const bloquePago = document.getElementById('bloquePago');
      const resultadoCambio = document.getElementById('resultadoCambio');
      const finalizarCompra = document.getElementById('finalizarCompra');

      const pagoInput = document.getElementById('pagoCliente');
      const pago = pagoInput && pagoInput.value ? Number(pagoInput.value) : 0;

      const tf = isFinite(window.totalFinal) ? Number(window.totalFinal) : total;

      return {
        carrito: items,
        total: Number(total.toFixed(2)),
        bloquePago_visible: bloquePago ? !bloquePago.classList.contains('hidden') : false,
        resultadoCambio_visible: resultadoCambio ? !resultadoCambio.classList.contains('hidden') : false,
        finalizar_visible: finalizarCompra ? !finalizarCompra.classList.contains('hidden') : false,
        total_final: Number(tf.toFixed(2)),
        pago: isFinite(pago) ? Number(pago) : 0,
        cambio: isFinite(pago) ? Number((pago - tf).toFixed(2)) : 0
      };
    }

    // ---- JSON -> DOM (sin redondeo) ----
    function renderFromState(s){
      const ul = document.getElementById('listaCarrito');
      if (ul){
        ul.innerHTML = '';
        (s.carrito || []).forEach((it, idx) => {
          const li = document.createElement('li');
          li.className = 'py-3 flex items-center justify-between';
          li.setAttribute('data-index', idx);
          li.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-cyan-50 text-[var(--brand-600)] flex items-center justify-center"><i data-lucide="package" class="w-4 h-4"></i></div>
              <span data-rol="nombre" class="text-slate-900 font-medium"></span>
            </div>
            <div class="flex items-center gap-4">
              <div data-rol="precio" class="text-slate-900 font-semibold text-lg"></div>
              <button type="button" class="p-2 rounded-lg hover:bg-red-50" title="Quitar del carrito">
                <i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i>
              </button>`;
          li.querySelector('[data-rol="nombre"]').textContent = it.nombre || '';
          li.querySelector('[data-rol="precio"]').textContent = '$' + fmt(it.precio || 0);
          ul.appendChild(li);
        });
        if (!s.carrito || s.carrito.length === 0){
          const empty = document.createElement('li');
          empty.className = 'py-8 text-center text-slate-500 empty-ring rounded-xl';
          empty.textContent = 'Tu carrito está vacío. Escanea un código o agrega manualmente.';
          ul.appendChild(empty);
        }
      }

      const totalBruto = document.getElementById('totalBruto');
      if (totalBruto) totalBruto.textContent = fmt(s.total || 0);

      const bloquePago = document.getElementById('bloquePago');
      if (bloquePago) bloquePago.classList.toggle('hidden', !s.bloquePago_visible);

      const resultadoCambio = document.getElementById('resultadoCambio');
      if (resultadoCambio) resultadoCambio.classList.toggle('hidden', !s.resultadoCambio_visible);

      const finalizarCompra = document.getElementById('finalizarCompra');
      if (finalizarCompra) finalizarCompra.classList.toggle('hidden', !s.finalizar_visible);

      const pagoInput = document.getElementById('pagoCliente');
      if (pagoInput) pagoInput.value = s.pago || '';

      const mTotal = document.getElementById('montoTotal');
      const mPago  = document.getElementById('montoPago');
      const mCambio= document.getElementById('montoCambio');
      if (mTotal)  mTotal.textContent  = '$' + fmt(s.total_final || s.total || 0);
      if (mPago)   mPago.textContent   = '$' + fmt(s.pago || 0);
      if (mCambio) mCambio.textContent = '$' + fmt(s.cambio || 0);

      if (window.lucide) lucide.createIcons();
    }

    function broadcast(){ if (!DISPLAY) socket.emit('update-display', collectState()); }

    // Abrir pago directo (sin redondeo)
    function mostrarPagoDirecto(){
      document.getElementById('bloquePago').classList.remove('hidden');
      document.getElementById('resultadoCambio').classList.add('hidden');
      document.getElementById('finalizarCompra').classList.add('hidden');
      broadcast();
    }

    let totalVenta = parseFloat((document.getElementById('totalBruto') && document.getElementById('totalBruto').textContent) || 0);
    let totalFinal = totalVenta; // sin redondeo

    function calcularCambio(){
      const pago = parseFloat(document.getElementById('pagoCliente').value);
      const resultadoDiv = document.getElementById('resultadoCambio');

      if (isNaN(pago) || pago < totalFinal){
        resultadoDiv.classList.remove('hidden');
        resultadoDiv.innerHTML = '<div class="text-red-600 text-center font-semibold">⚠️ El monto ingresado es insuficiente.</div>';
        document.getElementById('finalizarCompra').classList.add('hidden');
        broadcast();
        return;
      }

      const cambio = (pago - totalFinal).toFixed(2);
      document.getElementById('montoTotal').textContent  = `$${fmt(totalFinal)}`;
      document.getElementById('montoPago').textContent   = `$${fmt(pago)}`;
      document.getElementById('montoCambio').textContent = `$${cambio}`;

      resultadoDiv.classList.remove('hidden');
      document.getElementById('finalizarCompra').classList.remove('hidden');
      broadcast();
    }

    // Presets de efectivo
    function bindCashPresets(){
      document.querySelectorAll('[data-cash]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const inp = document.getElementById('pagoCliente');
          const total = Number((window.totalFinal ?? parseFloat(document.getElementById('totalBruto').textContent)) || 0);
          const v = b.dataset.cash === 'exact' ? total : Number(b.dataset.cash);
          inp.value = (isFinite(v) ? v : 0).toFixed(2);
          calcularCambio();
        });
      });
    }

    // Carrito: quitar
    async function quitarItem(idx){
      idx = Number(idx);
      try {
        const resp = await fetch('/carrito/eliminar', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ index: idx })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) return;

        const li = document.querySelector(`li[data-index="${idx}"]`);
        if (li) li.remove();

        document.querySelectorAll('#listaCarrito li').forEach((el, i) => {
          el.setAttribute('data-index', i);
          const btn = el.querySelector('button[onclick^="quitarItem"]');
          if (btn) btn.setAttribute('onclick', `quitarItem(${i})`);
        });

        totalVenta = Number(data.total) || 0;
        totalFinal = totalVenta; // sin redondeo
        document.getElementById('totalBruto').textContent = fmt(totalVenta);

        document.getElementById('bloquePago').classList.add('hidden');
        document.getElementById('resultadoCambio').classList.add('hidden');
        document.getElementById('finalizarCompra').classList.add('hidden');
        broadcast();
      } catch(e){ console.error(e); }
    }

    // Modal manual
    function abrirManual(){
      const m = document.getElementById('modalManual');
      document.getElementById('manNombre').value = '';
      document.getElementById('manPrecio').value = '';
      m.classList.remove('hidden'); m.classList.add('flex');
      setTimeout(()=> document.getElementById('manNombre').focus(), 50);
    }
    function cerrarManual(){ const m = document.getElementById('modalManual'); m.classList.add('hidden'); m.classList.remove('flex'); }

    async function agregarManual(){
      const nombre = (document.getElementById('manNombre').value || '').trim();
      const precio = Number(document.getElementById('manPrecio').value);
      if (!nombre){ alert('Escribe un nombre.'); return; }
      if (!isFinite(precio) || precio < 0){ alert('Precio inválido.'); return; }
      try{
        const resp = await fetch('/carrito/agregar_manual', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ nombre, precio }) });
        const data = await resp.json();
        if (!resp.ok || !data.ok){ alert('No se pudo agregar.'); return; }

        const ul = document.getElementById('listaCarrito');
        if (!ul){ location.reload(); return; }

        const idx = ul.querySelectorAll('li').length;
        const li = document.createElement('li');
        li.className = 'py-3 flex items-center justify-between';
        li.setAttribute('data-index', idx);
        li.innerHTML = `
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-cyan-50 text-[var(--brand-600)] flex items-center justify-center"><i data-lucide="package" class="w-4 h-4"></i></div>
            <span data-rol="nombre" class="text-slate-900 font-medium"></span>
          </div>
          <div class="flex items-center gap-4">
            <div data-rol="precio" class="text-slate-900 font-semibold text-lg"></div>
            <button type="button" class="p-2 rounded-lg hover:bg-red-50" title="Quitar del carrito" onclick="quitarItem(${idx})">
              <i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i>
            </button>
          </div>
        `;
        li.querySelector('[data-rol="nombre"]').textContent = nombre;
        li.querySelector('[data-rol="precio"]').textContent = '$' + fmt(precio);
        ul.appendChild(li);

        totalVenta = Number(data.total) || 0;
        totalFinal = totalVenta; // sin redondeo
        document.getElementById('totalBruto').textContent = fmt(totalVenta);

        document.getElementById('bloquePago').classList.add('hidden');
        document.getElementById('resultadoCambio').classList.add('hidden');
        document.getElementById('finalizarCompra').classList.add('hidden');

        cerrarManual();
        if (window.lucide) lucide.createIcons();
        broadcast();
      }catch(e){ console.error(e); alert('Error de red al agregar.'); }
    }

    // Reloj
    function tick(){ const el = document.getElementById('clock'); if (!el) return; const d = new Date(); el.textContent = d.toLocaleString(); }
    setInterval(tick, 1000); tick();

    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
      const code = document.getElementById('codigo'); if (code) code.focus();
      bindCashPresets();
      broadcast();
    });
  </script>
  <script>
/* === BEGIN: lector-codigo-barras (no intrusivo) === */
(() => {
  // 1) Configuración mínima (ajusta solo si hace falta)
  const TARGET_IDS = ["codigo", "codigoNuevo"]; // prioridad: el primero que exista en la página
  const INPUTS_CRITICOS = new Set(["pagoCliente", "manNombre", "manPrecio"]); // donde NO forzamos foco
  const MIN_LEN_SCAN = 6;           // longitud mínima razonable de un código de barras
  const MAX_GAP_MS = 100;           // máximo intervalo entre teclas para considerarlo "escaneo"
  const POST_ENTER_GRACE_MS = 200;  // margen tras Enter para decidir si era escaneo

  // 2) Utilidades
  const getTarget = () => {
    for (const id of TARGET_IDS) {
      const el = document.getElementById(id);
      if (el && el.tagName === "INPUT") return el;
    }
    return null;
  };

  const isTypingInCritical = () => {
    const a = document.activeElement;
    if (!a) return false;
    const isEditable = a.tagName === "INPUT" || a.tagName === "TEXTAREA" || a.isContentEditable;
    return !!(isEditable && INPUTS_CRITICOS.has(a.id));
  };

  const intentarFoco = () => {
    const t = getTarget();
    if (!t) return;
    if (isTypingInCritical()) return; // no molestamos al usuario en inputs críticos
    if (document.activeElement !== t) t.focus();
  };

  const submitAccion = (targetInput) => {
    // 1) Intentar enviar el formulario contenedor (si existe)
    const form = targetInput && targetInput.closest && targetInput.closest("form");
    if (form) {
      // Dispara eventos "submit" normales
      if (typeof form.requestSubmit === "function") {
        form.requestSubmit();
      } else {
        form.submit();
      }
      return;
    }
    // 2) Fallback: intentar click en botones comunes
    const botones = ["btnAgregar", "agregar", "btnSubmit", "submit"];
    for (const id of botones) {
      const btn = document.getElementById(id);
      if (btn && typeof btn.click === "function") {
        btn.click();
        return;
      }
    }
    // 3) Último recurso: disparar un evento Enter en el input (por compatibilidad)
    if (targetInput) {
      const evt = new KeyboardEvent("keydown", { key: "Enter", bubbles: true });
      targetInput.dispatchEvent(evt);
    }
  };

  // 3) Mantener foco amable en el input de código cuando sea apropiado
  const focusHandlers = [
    ["DOMContentLoaded", () => setTimeout(intentarFoco, 0)],
    ["focus", intentarFoco, window],
    ["click", () => setTimeout(intentarFoco, 0)],
  ];
  focusHandlers.forEach(([event, handler, tgt]) =>
    (tgt || document).addEventListener(event, handler, true)
  );

  // 4) Buffer y heurística de escaneo
  let scanBuffer = "";
  let lastKeyTs = 0;
  let lastEnterTs = 0;

  document.addEventListener("keydown", (e) => {
    // Si el usuario escribe en un input crítico, no interceptamos nada
    if (isTypingInCritical()) return;

    const now = Date.now();

    // Si es tecla imprimible (un solo carácter), la consideramos candidata para escaneo
    if (e.key && e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
      // Reiniciar buffer si pasó demasiado tiempo desde la última
      if (now - lastKeyTs > MAX_GAP_MS) scanBuffer = "";
      scanBuffer += e.key;
      lastKeyTs = now;
      // Asegurarnos de mantener el foco en el input objetivo (sin ser agresivos)
      setTimeout(intentarFoco, 0);
      return; // dejamos fluir el evento (no prevenimos)
    }

    // Si llega Enter, verificamos si lo anterior fue un "chorro" típico de lector
    if (e.key === "Enter") {
      // Heurística: hubo tecleo reciente y buffer con tamaño de código
      const recentlyTyped = (now - lastKeyTs) <= POST_ENTER_GRACE_MS;
      if (scanBuffer.length >= MIN_LEN_SCAN && recentlyTyped) {
        const target = getTarget();
        if (target) {
          target.value = scanBuffer;
          // Disparamos el submit/acción que ya maneja tu app
          submitAccion(target);
          // Limpiar buffer y marcar tiempo de Enter
          scanBuffer = "";
          lastKeyTs = 0;
          lastEnterTs = now;
          // Evitamos que este Enter haga algo adicional (doble submit, etc.)
          e.preventDefault();
          e.stopPropagation();
          return;
        }
      }
      // No era un escaneo: limpiamos buffer para no contaminar escritura normal
      scanBuffer = "";
      lastKeyTs = 0;
      lastEnterTs = now;
    }
  }, true);

  // 5) Limpieza de seguridad por inactividad (para no dejar basura en buffer)
  setInterval(() => {
    if (scanBuffer && Date.now() - lastKeyTs > 1000) {
      scanBuffer = "";
      lastKeyTs = 0;
    }
  }, 800);
})();
 /* === END: lector-codigo-barras === */
</script>

</body>
</html>
