<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PilotoPOS – Visor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, "Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#0f172a; }
    .card { background:#fff; border-radius:1.25rem; padding:1.25rem; box-shadow:0 20px 40px -20px rgba(0,0,0,.5); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
  <div class="card w-full max-w-3xl">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-cyan-700">Cuenta del cliente (en vivo)</h1>
      <span id="badgeRedondeo" class="text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-600">—</span>
    </div>

    <ul id="lista" class="divide-y divide-gray-100"></ul>

    <div class="mt-4 space-y-1 text-right">
      <div class="text-lg">Subtotal: <span id="subtotal" class="font-semibold">$0.00</span></div>
      <div class="text-xl">Total a pagar: <span id="total" class="font-bold text-gray-900">$0.00</span></div>
      <div class="text-sm text-gray-600">Pago: <span id="pago">$0.00</span> · Cambio: <span id="cambio">$0.00</span></div>
    </div>

    <div id="estado" class="mt-4 text-sm text-gray-500">Esperando datos…</div>
  </div>

  <script>
    function money(n){ return '$' + (Number(n||0).toFixed(2)); }
    const lista = document.getElementById('lista');
    const estado = document.getElementById('estado');

    function render(payload){
      if (payload.clear){
        lista.innerHTML = '';
        document.getElementById('subtotal').textContent = '$0.00';
        document.getElementById('total').textContent = '$0.00';
        document.getElementById('pago').textContent = '$0.00';
        document.getElementById('cambio').textContent = '$0.00';
        const b = document.getElementById('badgeRedondeo');
        b.textContent = '—';
        b.className = 'text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-600';
        estado.textContent = 'Listo para la siguiente compra';
        return;
      }

      const items = payload.carrito || [];
      lista.innerHTML = '';
      items.forEach(it => {
        const li = document.createElement('li');
        li.className = 'py-3 flex items-center justify-between';
        li.innerHTML = `<div class="text-gray-800">${it.nombre}</div><div class="font-semibold">${money(it.precio)}</div>`;
        lista.appendChild(li);
      });

      document.getElementById('subtotal').textContent = money(payload.total);
      document.getElementById('total').textContent    = money(payload.total_final ?? payload.total);
      document.getElementById('pago').textContent     = money(payload.pago);
      document.getElementById('cambio').textContent   = money(payload.cambio);

      const b = document.getElementById('badgeRedondeo');
      if (payload.redondeo === 'si'){ b.textContent = 'Redondeo: Sí'; b.className = 'text-xs px-3 py-1 rounded-full bg-emerald-50 text-emerald-700'; }
      else if (payload.redondeo === 'no'){ b.textContent = 'Redondeo: No'; b.className = 'text-xs px-3 py-1 rounded-full bg-rose-50 text-rose-700'; }
      else { b.textContent = '—'; b.className = 'text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-600'; }

      estado.textContent = 'Actualizado ' + new Date(payload.ts || Date.now()).toLocaleTimeString();
    }

    try{
      const es = new EventSource('/events');
      es.addEventListener('carrito_sync', (ev) => {
        const payload = JSON.parse(ev.data || '{}');
        render(payload);
      });
      es.addEventListener('ping', ()=>{ estado.textContent = 'Conectado'; });
    } catch (e){
      estado.textContent = 'SSE no disponible';
    }
  </script>
</body>
</html>
