<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PilotoPOS – Proveedores</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { background: #fff; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.06); padding: 1.25rem; }
    .input, .select, .textarea {
      border: 1px solid rgba(14,116,144,.18);
      border-radius: .75rem; padding: .6rem .85rem; outline: none;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }
    .input:focus, .select:focus, .textarea:focus {
      border-color: rgb(14 116 144);
      box-shadow: 0 0 0 4px rgba(14,116,144,.15);
    }
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:.75rem; font-weight:600; padding:.55rem .9rem; }
    .btn-prim { background:#0ea5a4; color:#fff; }
    .btn-warn { background:#f59e0b; color:#fff; }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-ghost { background:#f3f4f6; color:#111827; }
    .btn:hover { filter: brightness(1.02); transform: translateY(-1px); }
    .table-wrap { overflow:auto; }
    thead th { position: sticky; top: 0; z-index: 1; background:#ecfeff; color:#0e7490; border-bottom:1px solid rgba(14,116,144,.15); }
    tbody tr:hover { background:#fafafa; }
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { background:#fff; border-radius:1rem; padding:1rem; width:100%; max-width:900px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .chip { font-weight:700; font-size:.75rem; padding:.25rem .6rem; border-radius:9999px; display:inline-block; }
    .chip-green { background:#dcfce7; color:#065f46; }
    .chip-gray { background:#f3f4f6; color:#374151; }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Navbar con iconos -->
  <nav class="bg-cyan-600 text-white p-4 flex gap-6 justify-center text-sm font-semibold tracking-wide">
    <a href="/" class="hover:underline flex items-center gap-2">
      <i data-lucide="shopping-cart" class="w-4 h-4"></i> Ventas
    </a>
    <a href="/almacen" class="hover:underline flex items-center gap-2">
      <i data-lucide="box" class="w-4 h-4"></i> Almacén
    </a>
    <a href="/historial" class="hover:underline flex items-center gap-2">
      <i data-lucide="bar-chart" class="w-4 h-4"></i> Historial
    </a>
    <a href="/centavos" class="hover:underline flex items-center gap-2">
      <i data-lucide="coins" class="w-4 h-4"></i> Centavos
    </a>
    <a href="/proveedores" class="underline flex items-center gap-2">
      <i data-lucide="truck" class="w-4 h-4"></i> Proveedores
    </a>
    <a href="/usuarios" class="hover:underline flex items-center gap-2">
      <i data-lucide="users" class="w-4 h-4"></i> Usuarios
    </a>
    <a href="/login" class="hover:underline flex items-center gap-2">
      <i data-lucide="lock" class="w-4 h-4"></i> Login
    </a>
  </nav>

  <main class="max-w-7xl mx-auto py-10 px-6">
    <h1 class="text-3xl font-bold text-cyan-700 mb-6 flex items-center gap-2">
      <i data-lucide="truck" class="w-7 h-7"></i> Módulo de Proveedores
    </h1>

    <!-- Filtros + Crear -->
    <div class="card mb-6">
      <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
        <div class="flex items-stretch w-full md:w-1/2">
          <div class="relative flex-1">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-cyan-700"></i>
            <input id="buscar" type="text" placeholder="Buscar por nombre, RFC o contacto..." class="input pl-9 w-full">
          </div>
        </div>
        <div class="flex gap-2">
          <select id="filtroActivo" class="select">
            <option value="">Todos</option>
            <option value="1">Activos</option>
            <option value="0">Inactivos</option>
          </select>
          <button id="btnNuevo" class="btn btn-prim">
            <i data-lucide="plus"></i> Nuevo proveedor
          </button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card table-wrap">
      <table class="w-full text-sm table-fixed">
        <colgroup>
          <col class="w-64"><col><col class="w-40"><col class="w-28"><col class="w-[22rem]">
        </colgroup>
        <thead>
          <tr>
            <th class="px-4 py-2 text-left">Proveedor</th>
            <th class="px-4 py-2 text-left">Contacto / Email</th>
            <th class="px-4 py-2 text-left">Condición / Moneda</th>
            <th class="px-4 py-2 text-left">Estado</th>
            <th class="px-4 py-2 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbodyProveedores" class="divide-y"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Crear/Editar -->
  <div id="modalProveedor" class="modal-backdrop">
    <div class="modal">
      <div class="flex items-center justify-between mb-3">
        <h2 id="modalTitulo" class="text-xl font-bold text-cyan-700">Nuevo proveedor</h2>
        <button id="btnCerrarModal" class="text-gray-500 hover:text-gray-800">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <i data-lucide="id-card" class="w-4 h-4"></i> Datos generales
          </h3>
          <div class="grid gap-3">
            <input id="prov_id" type="hidden">
            <input id="prov_nombre" class="input" placeholder="Nombre / Razón social *">
            <input id="prov_rfc" class="input" placeholder="RFC / Identificación">
            <input id="prov_email" class="input" placeholder="Email principal">
            <input id="prov_tel" class="input" placeholder="Teléfono principal">
            <input id="prov_dir" class="input" placeholder="Dirección">
            <div class="grid grid-cols-2 gap-3">
              <select id="prov_cond_pago" class="select">
                <option value="Contado">Contado</option>
                <option value="15 días">15 días</option>
                <option value="30 días">30 días</option>
                <option value="45 días">45 días</option>
              </select>
              <select id="prov_moneda" class="select">
                <option value="MXN">MXN</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div class="grid grid-cols-2 gap-3 items-center">
              <input id="prov_iva" type="number" step="0.01" class="input" placeholder="IVA % (e.g. 16)">
              <label class="flex items-center gap-2"><input id="prov_activo" type="checkbox" checked> Activo</label>
            </div>
            <textarea id="prov_notas" rows="3" class="textarea" placeholder="Notas"></textarea>
          </div>
        </div>

        <div class="card">
          <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <i data-lucide="users" class="w-4 h-4"></i> Contactos
          </h3>
          <div id="wrapContactos" class="space-y-3"></div>
          <button id="btnAddContacto" class="btn btn-warn mt-2"><i data-lucide="user-plus"></i> Añadir contacto</button>

          <div class="h-4"></div>

          <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
            <i data-lucide="price-tag" class="w-4 h-4"></i> Lista de precios
          </h3>
          <div id="wrapPrecios" class="space-y-3"></div>
          <button id="btnAddPrecio" class="btn btn-warn mt-2"><i data-lucide="plus-circle"></i> Añadir precio</button>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3 mt-4">
        <button id="btnGuardar" class="btn btn-prim"><i data-lucide="save"></i> Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // Estado
    let proveedores = [];
    let editId = null;

    // Helpers UI
    function openModal(titulo = 'Nuevo proveedor', data = null) {
      document.getElementById('modalTitulo').textContent = titulo;
      document.getElementById('modalProveedor').style.display = 'flex';
      // Reset
      document.getElementById('prov_id').value = data?.id || '';
      document.getElementById('prov_nombre').value = data?.nombre || '';
      document.getElementById('prov_rfc').value = data?.rfc || '';
      document.getElementById('prov_email').value = data?.email || '';
      document.getElementById('prov_tel').value = data?.telefono || '';
      document.getElementById('prov_dir').value = data?.direccion || '';
      document.getElementById('prov_cond_pago').value = data?.condiciones_pago || 'Contado';
      document.getElementById('prov_moneda').value = data?.moneda || 'MXN';
      document.getElementById('prov_iva').value = data?.iva_porcentaje ?? 16;
      document.getElementById('prov_activo').checked = data?.activo ?? true;
      document.getElementById('prov_notas').value = data?.notas || '';

      // Render contactos
      const wrapC = document.getElementById('wrapContactos');
      wrapC.innerHTML = '';
      (data?.contactos || []).forEach(c => addContactoRow(c));
      if ((data?.contactos || []).length === 0) addContactoRow();

      // Render precios
      const wrapP = document.getElementById('wrapPrecios');
      wrapP.innerHTML = '';
      (data?.precios || []).forEach(p => addPrecioRow(p));
      if ((data?.precios || []).length === 0) addPrecioRow();

      if (window.lucide) lucide.createIcons();
    }
    function closeModal(){ document.getElementById('modalProveedor').style.display = 'none'; }

    function addContactoRow(c = {}) {
      const wrap = document.getElementById('wrapContactos');
      const div = document.createElement('div');
      div.className = 'grid grid-cols-2 gap-3';
      div.innerHTML = `
        <input class="input" placeholder="Nombre" value="${c.nombre || ''}">
        <input class="input" placeholder="Cargo" value="${c.cargo || ''}">
        <input class="input" placeholder="Email" value="${c.email || ''}">
        <div class="flex gap-2">
          <input class="input w-full" placeholder="Teléfono / WhatsApp" value="${c.telefono || ''}">
          <button class="btn btn-danger" title="Eliminar contacto" onclick="this.closest('div.grid').remove()">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      `;
      wrap.appendChild(div);
    }

    function addPrecioRow(p = {}) {
      const wrap = document.getElementById('wrapPrecios');
      const div = document.createElement('div');
      div.className = 'grid grid-cols-5 gap-2 items-center';
      div.innerHTML = `
        <input class="input" placeholder="SKU" value="${p.sku || ''}">
        <input class="input" placeholder="Descripción" value="${p.descripcion || ''}">
        <input class="input" type="number" step="0.01" placeholder="Precio compra" value="${p.precio_compra ?? ''}">
        <input class="input" type="number" step="1" placeholder="MOQ" value="${p.moq ?? ''}">
        <div class="flex gap-2">
          <input class="input w-full" type="number" step="1" placeholder="Lead time (días)" value="${p.lead_time_dias ?? ''}">
          <button class="btn btn-danger" title="Eliminar precio" onclick="this.closest('div.grid').remove()">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      `;
      wrap.appendChild(div);
    }

    function leerContactos() {
      const rows = Array.from(document.querySelectorAll('#wrapContactos .grid'));
      return rows.map(r => {
        const inputs = r.querySelectorAll('input');
        return {
          nombre: inputs[0].value.trim(),
          cargo: inputs[1].value.trim(),
          email: inputs[2].value.trim(),
          telefono: inputs[3].value.trim(),
        };
      }).filter(x => x.nombre || x.email || x.telefono);
    }

    function leerPrecios() {
      const rows = Array.from(document.querySelectorAll('#wrapPrecios .grid'));
      return rows.map(r => {
        const inputs = r.querySelectorAll('input');
        return {
          sku: inputs[0].value.trim(),
          descripcion: inputs[1].value.trim(),
          precio_compra: Number(inputs[2].value || 0),
          moq: Number(inputs[3].value || 0),
          lead_time_dias: Number(inputs[4].value || 0),
        };
      }).filter(x => x.sku);
    }

    // ------- NUEVAS ACCIONES -------
    function verProductos(id){
      // Navega a Almacén con proveedor_id (no rompe nada si no lo usas aún)
      window.location.href = `/almacen?proveedor_id=${encodeURIComponent(id)}`;
    }
    function verHistorial(id){
      // Navega a Historial con proveedor_id
      window.location.href = `/historial?proveedor_id=${encodeURIComponent(id)}`;
    }

    // Render tabla
    function renderTabla() {
      const q = document.getElementById('buscar').value.toLowerCase().trim();
      const fa = document.getElementById('filtroActivo').value;
      const tbody = document.getElementById('tbodyProveedores');
      tbody.innerHTML = '';

      proveedores
        .filter(p => {
          const matchQ = !q || [p.nombre, p.rfc, p.email, p.telefono].join(' ').toLowerCase().includes(q);
          const matchA = fa === '' || Number(!!p.activo).toString() === fa;
          return matchQ && matchA;
        })
        .forEach(p => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          tr.innerHTML = `
            <td class="px-4 py-2">
              <div class="font-semibold text-gray-800">${p.nombre || '—'}</div>
              <div class="text-xs text-gray-500">${p.rfc || ''}</div>
            </td>
            <td class="px-4 py-2">
              <div class="text-gray-700">${(p.contactos?.[0]?.nombre || '—')} ${(p.contactos?.[0]?.cargo ? '· ' + p.contactos[0].cargo : '')}</div>
              <div class="text-xs text-gray-500">${p.email || ''}</div>
            </td>
            <td class="px-4 py-2">
              <div class="text-gray-700">${p.condiciones_pago || 'Contado'}</div>
              <div class="text-xs text-gray-500">${p.moneda || 'MXN'} · IVA ${p.iva_porcentaje ?? 16}%</div>
            </td>
            <td class="px-4 py-2">
              ${p.activo ? '<span class="chip chip-green">Activo</span>' : '<span class="chip chip-gray">Inactivo</span>'}
            </td>
            <td class="px-4 py-2">
              <div class="flex flex-wrap gap-2">
                <button class="btn btn-warn" title="Editar" onclick='editarProveedor(${JSON.stringify(p).replace(/'/g,"&apos;")})'>
                  <i data-lucide="pencil"></i> Editar
                </button>
                <button class="btn btn-danger" title="Eliminar" onclick="eliminarProveedor('${p.id}')">
                  <i data-lucide="trash-2"></i> Eliminar
                </button>
                <button class="btn btn-ghost" title="Ver productos" onclick="verProductos('${p.id}')">
                  <i data-lucide="package-search"></i> Ver productos
                </button>
                <button class="btn btn-ghost" title="Historial de compras" onclick="verHistorial('${p.id}')">
                  <i data-lucide="history"></i> Historial
                </button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

      if (window.lucide) lucide.createIcons();
    }

    // Acciones
    function nuevoProveedor(){ editId=null; openModal('Nuevo proveedor'); }

    function editarProveedor(p){
      editId = p.id;
      openModal('Editar proveedor', p);
    }

    async function eliminarProveedor(id){
      if (!confirm('¿Eliminar proveedor?')) return;
      const res = await fetch('/eliminar_proveedor', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (data.success) { await cargarProveedores(); alert('✅ Proveedor eliminado'); }
      else alert('❌ No se pudo eliminar');
    }

    async function guardarProveedor(){
      const payload = {
        id: document.getElementById('prov_id').value || null,
        nombre: document.getElementById('prov_nombre').value.trim(),
        rfc: document.getElementById('prov_rfc').value.trim(),
        email: document.getElementById('prov_email').value.trim(),
        telefono: document.getElementById('prov_tel').value.trim(),
        direccion: document.getElementById('prov_dir').value.trim(),
        condiciones_pago: document.getElementById('prov_cond_pago').value,
        moneda: document.getElementById('prov_moneda').value,
        iva_porcentaje: Number(document.getElementById('prov_iva').value || 16),
        activo: document.getElementById('prov_activo').checked,
        notas: document.getElementById('prov_notas').value.trim(),
        contactos: leerContactos(),
        precios: leerPrecios()
      };

      if (!payload.nombre) { alert('⚠️ Nombre es obligatorio'); return; }

      const res = await fetch('/guardar_proveedor', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.success) {
        await cargarProveedores();
        closeModal();
        alert('✅ Proveedor guardado');
      } else {
        alert('❌ No se pudo guardar');
      }
    }

    async function cargarProveedores(){
      const res = await fetch('/api/proveedores');
      proveedores = await res.json();
      renderTabla();
    }

    // Event listeners
    document.getElementById('btnNuevo').addEventListener('click', nuevoProveedor);
    document.getElementById('btnCerrarModal').addEventListener('click', closeModal);
    document.getElementById('btnGuardar').addEventListener('click', guardarProveedor);
    document.getElementById('buscar').addEventListener('input', renderTabla);
    document.getElementById('filtroActivo').addEventListener('change', renderTabla);
    document.getElementById('btnAddContacto').addEventListener('click', ()=> addContactoRow());
    document.getElementById('btnAddPrecio').addEventListener('click', ()=> addPrecioRow());

    // Init
    (async function init(){
      await cargarProveedores();
      if (window.lucide) lucide.createIcons();
    })();
  </script>
</body>
</html>
